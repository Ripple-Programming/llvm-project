// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py UTC_ARGS: --version 5
// REQUIRES: hexagon-registered-target
// RUN: %clang %s -O2 -fenable-ripple -target hexagon -mv81 -mhvx=v81 -S -emit-llvm -o - | FileCheck %s

#include <ripple.h>
// CHECK-LABEL: define dso_local void @_Z3addPDF16bS_S_(
// CHECK-SAME: ptr noundef writeonly captures(none) [[C:%.*]], ptr noundef readonly captures(none) [[A:%.*]], ptr noundef readonly captures(none) [[B:%.*]]) local_unnamed_addr #[[ATTR0:[0-9]+]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:  [[TMP0:%.*]] = load <64 x bfloat>, ptr [[A]], align 2
// CHECK:       ret void

void add(__bf16 *c, __bf16 *a, __bf16 *b) {
  ripple_block_t BS = ripple_set_block_shape(0, 64);
  size_t v = ripple_id(BS, 0);
  c[v] = a[v] + b[v];
}

// CHECK-LABEL: define dso_local void @_Z6cmp_lePiPDF16bS0_(
// CHECK-SAME: ptr noundef writeonly captures(none) [[C:%.*]], ptr noundef readonly captures(none) [[A:%.*]], ptr noundef readonly captures(none) [[B:%.*]]) local_unnamed_addr #[[ATTR0]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:  [[TMP0:%.*]] = load <64 x bfloat>, ptr [[A]], align 2
// CHECK:       ret void
//
void cmp_le(int *c, __bf16 *a, __bf16 *b) {
  auto BS = ripple_set_block_shape(0, 64);
  size_t v = ripple_id(BS, 0);
  c[v] = a[v] < b[v];
}

static size_t invert(size_t dst_id, size_t block_size) {
  return block_size - dst_id -1;
}

// CHECK-LABEL: define dso_local void @shuffle(
// CHECK-SAME: ptr noundef writeonly captures(none) [[B:%.*]], ptr noundef readonly captures(none) [[A:%.*]]) local_unnamed_addr #[[ATTR1:[0-9]+]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:    [[TMP0:%.*]] = load <64 x bfloat>, ptr [[A]], align 2
// CHECK:       ret void

extern "C" void shuffle(__bf16 *b, __bf16 *a) {
  ripple_block_t BS = ripple_set_block_shape(0, 64);
  size_t v = ripple_id(BS, 0);
  b[v] = ripple_shuffle(a[v], invert);
}

// CHECK-LABEL: define dso_local noundef bfloat @_Z9reduceaddPDF16b(
// CHECK-SAME: ptr noundef readonly captures(none) [[A:%.*]]) local_unnamed_addr #[[ATTR2:[0-9]+]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:  [[TMP0:%.*]] = load <64 x bfloat>, ptr [[A]], align 2
// CHECK:       ret bfloat [[CONV1_I:%.*]]

__bf16 reduceadd(__bf16 *a) {
  ripple_block_t BS = ripple_set_block_shape(0, 64);
  size_t v = ripple_id(BS, 0);
  return ripple_reduceadd(0b1, a[v]);
}

// CHECK-LABEL: define dso_local noundef bfloat @_Z9reducemaxPDF16b(
// CHECK-SAME: ptr noundef readonly captures(none) [[A:%.*]]) local_unnamed_addr #[[ATTR2]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:  [[TMP0:%.*]] = load <64 x bfloat>, ptr [[A]], align 2
// CHECK:       ret bfloat [[CONV1_I:%.*]]

__bf16 reducemax(__bf16 *a) {
  auto BS = ripple_set_block_shape(0, 64);
  size_t v = ripple_id(BS, 0);
  return ripple_reducemax(0b1, a[v]);
}

// CHECK-LABEL: define dso_local noundef bfloat @_Z13reducemaximumPDF16b(
// CHECK-SAME: ptr noundef readonly captures(none) [[A:%.*]]) local_unnamed_addr #[[ATTR2]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:  [[TMP0:%.*]] = load <64 x bfloat>, ptr [[A]], align 2
// CHECK:       ret bfloat [[CONV1_I:%.*]]

__bf16 reducemaximum(__bf16 *a) {
  auto BS = ripple_set_block_shape(0, 64);
  size_t v = ripple_id(BS, 0);
  return ripple_reducemaximum(0b1, a[v]);
}

// CHECK-LABEL: define dso_local noundef bfloat @_Z9reduceminPDF16b(
// CHECK-SAME: ptr noundef readonly captures(none) [[A:%.*]]) local_unnamed_addr #[[ATTR2]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:  [[TMP0:%.*]] = load <64 x bfloat>, ptr [[A]], align 2
// CHECK:       ret bfloat [[CONV1_I:%.*]]

__bf16 reducemin(__bf16 *a) {
  ripple_block_t BS = ripple_set_block_shape(0, 64);
  size_t v = ripple_id(BS, 0);
  return ripple_reducemin(0b1, a[v]);
}

// CHECK-LABEL: define dso_local noundef bfloat @_Z13reduceminimumPDF16b(
// CHECK-SAME: ptr noundef readonly captures(none) [[A:%.*]]) local_unnamed_addr #[[ATTR2]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:  [[TMP0:%.*]] = load <64 x bfloat>, ptr [[A]], align 2
// CHECK:       ret bfloat [[CONV1_I:%.*]]

__bf16 reduceminimum(__bf16 *a) {
  ripple_block_t BS = ripple_set_block_shape(0, 64);
  size_t v = ripple_id(BS, 0);
  return ripple_reduceminimum(0b1, a[v]);
}

// CHECK-LABEL: define dso_local void @_Z5bcastPDF16bDF16b(
// CHECK-SAME: ptr noundef writeonly captures(none) [[B:%.*]], bfloat noundef [[A:%.*]]) local_unnamed_addr #[[ATTR3:[0-9]+]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:  [[CONV_I:%.*]] = fpext bfloat [[A]] to float
// CHECK:       ret void

void bcast(__bf16 *b, __bf16 a) {
  auto BS = ripple_set_block_shape(0, 64);
  size_t v = ripple_id(BS, 0);
  b[v] = ripple_broadcast(BS, 0b1, a);
}

// CHECK-LABEL: define dso_local noundef bfloat @_Z6slice0PDF16b(
// CHECK-SAME: ptr noundef readonly captures(none) [[A:%.*]]) local_unnamed_addr #[[ATTR2]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:  [[TMP0:%.*]] = load <64 x bfloat>, ptr [[A]], align 2
// CHECK:       ret bfloat [[TMP1:%.*]]
//
__bf16 slice0(__bf16 *a) {
  auto BS = ripple_set_block_shape(0, 64);
  size_t v = ripple_id(BS, 0);
  return ripple_slice<3>(a[v]);
}


// CHECK-LABEL: define dso_local noundef bfloat @_Z6slice1PDF16b(
// CHECK-SAME: ptr noundef readonly captures(none) [[A:%.*]]) local_unnamed_addr #[[ATTR2]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:  [[TMP0:%.*]] = load <64 x bfloat>, ptr [[A]], align 2
// CHECK:       ret bfloat [[TMP1:%.*]]

__bf16 slice1(__bf16 *a) {
  auto BS = ripple_set_block_shape(0, 32, 2);
  size_t v0 = ripple_id(BS, 0);
  size_t v1 = ripple_id(BS, 1);
  __bf16 slice_0 = ripple_slice<3, -1>(a[32*v1 + v0]);
  return ripple_slice<0, 1>(slice_0);
}
