// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py UTC_ARGS: --version 5
// REQUIRES: target-x86_64 || target-aarch64 || target=hexagon{{.*}}
// RUN: %clang -fenable-ripple -S -emit-llvm %s -o - | FileCheck %s

#include <ripple.h>

// CHECK-LABEL: define dso_local void @check(
// CHECK-SAME: ptr noundef [[OUT:%.*]]) #[[ATTR0:[0-9]+]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:    [[OUT_ADDR:%.*]] = alloca ptr
// CHECK-NEXT:    [[BS:%.*]] = alloca ptr
// CHECK-NEXT:    [[BS2:%.*]] = alloca ptr
// CHECK-NEXT:    store ptr [[OUT]], ptr [[OUT_ADDR]]
// CHECK-NEXT:    store ptr poison, ptr [[BS]]
// CHECK-NEXT:    [[TMP0:%.*]] = load ptr, ptr [[BS]]
// CHECK-NEXT:    store ptr [[TMP0]], ptr [[BS2]]
// CHECK-NEXT:    [[TMP1:%.*]] = load ptr, ptr [[OUT_ADDR]]
// CHECK-NEXT:    [[TMP2:%.*]] = load ptr, ptr [[BS]]
// CHECK-NEXT:    [[ARRAYIDX:%.*]] = getelementptr inbounds nuw float, ptr [[TMP1]], i{{(32|64)}} 0
// CHECK-NEXT:    [[ARRAYIDX_RIPPLE_LS_INSTANCE:%.*]] = getelementptr i8, ptr [[ARRAYIDX]], <32 x i{{(32|64)}}> <i{{(32|64)}} 0, i{{(32|64)}} 4, i{{(32|64)}} 8, i{{(32|64)}} 12, i{{(32|64)}} 16, i{{(32|64)}} 20, i{{(32|64)}} 24, i{{(32|64)}} 28, i{{(32|64)}} 32, i{{(32|64)}} 36, i{{(32|64)}} 40, i{{(32|64)}} 44, i{{(32|64)}} 48, i{{(32|64)}} 52, i{{(32|64)}} 56, i{{(32|64)}} 60, i{{(32|64)}} 64, i{{(32|64)}} 68, i{{(32|64)}} 72, i{{(32|64)}} 76, i{{(32|64)}} 80, i{{(32|64)}} 84, i{{(32|64)}} 88, i{{(32|64)}} 92, i{{(32|64)}} 96, i{{(32|64)}} 100, i{{(32|64)}} 104, i{{(32|64)}} 108, i{{(32|64)}} 112, i{{(32|64)}} 116, i{{(32|64)}} 120, i{{(32|64)}} 124>
// CHECK-NEXT:    store <32 x float> splat (float 4.200000e+01), ptr [[ARRAYIDX]]
// CHECK-NEXT:    store ptr poison, ptr [[BS]]
// CHECK-NEXT:    [[TMP3:%.*]] = load ptr, ptr [[OUT_ADDR]]
// CHECK-NEXT:    [[TMP4:%.*]] = load ptr, ptr [[BS]]
// CHECK-NEXT:    [[ARRAYIDX1:%.*]] = getelementptr inbounds nuw float, ptr [[TMP3]], i{{(32|64)}} 0
// CHECK-NEXT:    [[ARRAYIDX1_RIPPLE_LS_INSTANCE:%.*]] = getelementptr i8, ptr [[ARRAYIDX1]], <8 x i{{(32|64)}}> <i{{(32|64)}} 0, i{{(32|64)}} 4, i{{(32|64)}} 8, i{{(32|64)}} 12, i{{(32|64)}} 16, i{{(32|64)}} 20, i{{(32|64)}} 24, i{{(32|64)}} 28>
// CHECK-NEXT:    store <8 x float> splat (float 3.300000e+01), ptr [[ARRAYIDX1]]
// CHECK-NEXT:    [[TMP5:%.*]] = load ptr, ptr [[OUT_ADDR]]
// CHECK-NEXT:    [[TMP6:%.*]] = load ptr, ptr [[BS2]]
// CHECK-NEXT:    [[ARRAYIDX2:%.*]] = getelementptr inbounds nuw float, ptr [[TMP5]], i{{(32|64)}} 0
// CHECK-NEXT:    [[ARRAYIDX2_RIPPLE_LS_INSTANCE:%.*]] = getelementptr i8, ptr [[ARRAYIDX2]], <32 x i{{(32|64)}}> <i{{(32|64)}} 0, i{{(32|64)}} 4, i{{(32|64)}} 8, i{{(32|64)}} 12, i{{(32|64)}} 16, i{{(32|64)}} 20, i{{(32|64)}} 24, i{{(32|64)}} 28, i{{(32|64)}} 32, i{{(32|64)}} 36, i{{(32|64)}} 40, i{{(32|64)}} 44, i{{(32|64)}} 48, i{{(32|64)}} 52, i{{(32|64)}} 56, i{{(32|64)}} 60, i{{(32|64)}} 64, i{{(32|64)}} 68, i{{(32|64)}} 72, i{{(32|64)}} 76, i{{(32|64)}} 80, i{{(32|64)}} 84, i{{(32|64)}} 88, i{{(32|64)}} 92, i{{(32|64)}} 96, i{{(32|64)}} 100, i{{(32|64)}} 104, i{{(32|64)}} 108, i{{(32|64)}} 112, i{{(32|64)}} 116, i{{(32|64)}} 120, i{{(32|64)}} 124>
// CHECK-NEXT:    store <32 x float> splat (float 7.400000e+01), ptr [[ARRAYIDX2]]
// CHECK-NEXT:    ret void
//
void check(float *out) {
  ripple_block_t BS = ripple_set_block_shape(0, 32, 4);
  ripple_block_t BS2 = BS;
  out[ripple_id(BS, 0)] = 42;
  BS = ripple_set_block_shape(0, 8);
  out[ripple_id(BS, 0)] = 33;
  out[ripple_id(BS2, 0)] = 74;
}
